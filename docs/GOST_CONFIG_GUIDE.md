# Gost 本地化配置操作说明

## 配置场景示例

假设你有以下服务器：
- **落地鸡（美国）**：IP `1.2.3.4`，运行网站服务（本地 80 端口）
- **线路鸡（香港）**：IP `5.6.7.8`，用于中转流量

**目标**：通过香港服务器访问美国服务器的网站

---

## 第一步：在落地鸡上配置

### 操作机器
🖥️ **落地鸡（美国服务器 1.2.3.4）**

### 操作步骤

```bash
# 1. SSH 登录到落地鸡
ssh root@1.2.3.4

# 2. 运行 fish 命令
fish

# 3. 选择菜单
主菜单 → 8. 🌐 网络隧道工具
       → 1. 🎯 配置本机为落地鸡

# 4. 输入配置信息
TLS 监听端口 [8443]: 8443        ← 按回车使用默认值
转发目标 [127.0.0.1:80]: 127.0.0.1:80  ← 本地网站端口

# 5. 确认配置
确认配置并启动服务? (y/n): y
```

### 端口说明

| 端口 | 用途 | 说明 |
|:---|:---|:---|
| `8443` | TLS 监听端口 | 线路鸡会连接到这个端口 |
| `80` | 本地服务端口 | 实际的网站服务端口 |

### 配置结果

```
✓ 配置完成！服务已启动
  监听端口: 8443 (TLS)
  转发到: 127.0.0.1:80
  服务状态: 运行中
  
  线路鸡可以连接到: 1.2.3.4:8443
```

### 防火墙设置

```bash
# 开放 TLS 端口（如果有防火墙）
ufw allow 8443/tcp
```

---

## 第二步：在线路鸡上配置

### 操作机器
🖥️ **线路鸡（香港服务器 5.6.7.8）**

### 操作步骤

```bash
# 1. SSH 登录到线路鸡
ssh root@5.6.7.8

# 2. 运行 fish 命令
fish

# 3. 选择菜单
主菜单 → 8. 🌐 网络隧道工具
       → 2. 🚀 配置本机为线路鸡

# 4. 添加转发规则
当前转发规则: (暂无转发规则)

选择: 1. ➕ 添加转发规则

# 5. 输入配置信息
落地鸡名称: 美国网站
落地鸡 IP: 1.2.3.4              ← 落地鸡的 IP
落地鸡 TLS 端口 [8443]: 8443    ← 落地鸡的 TLS 端口
本地监听端口 [10001]: 10001     ← 用户访问的端口

# 6. 应用配置
选择: 3. ▶️ 应用配置并启动服务
```

### 端口说明

| 端口 | 用途 | 说明 |
|:---|:---|:---|
| `10001` | 对外服务端口 | 用户访问这个端口 |
| `8443` | 连接落地鸡端口 | 连接到落地鸡的 TLS 端口 |

### 配置结果

```
✓ 服务已启动

访问方式:
  http://本机IP:10001 → 美国网站
```

### 防火墙设置

```bash
# 开放对外服务端口
ufw allow 10001/tcp
```

---

## 第三步：使用服务

### 访问方式

```bash
# 从任何地方访问
curl http://5.6.7.8:10001

# 实际访问路径：
# 用户 → 香港:10001 → [TLS加密] → 美国:8443 → 美国:80
```

### 浏览器访问

```
http://5.6.7.8:10001
```

---

## 多落地鸡配置示例

### 场景
- 落地鸡 A（美国 1.2.3.4）：网站服务
- 落地鸡 B（欧洲 9.10.11.12）：API 服务
- 线路鸡（香港 5.6.7.8）：中转

### 配置步骤

#### 1. 在落地鸡 A 上配置

```
机器: 1.2.3.4
TLS 端口: 8443
转发目标: 127.0.0.1:80
```

#### 2. 在落地鸡 B 上配置

```
机器: 9.10.11.12
TLS 端口: 8443
转发目标: 127.0.0.1:3000
```

#### 3. 在线路鸡上配置

**添加第一个转发规则：**
```
落地鸡名称: 美国网站
落地鸡 IP: 1.2.3.4
落地鸡 TLS 端口: 8443
本地监听端口: 10001
```

**添加第二个转发规则：**
```
落地鸡名称: 欧洲API
落地鸡 IP: 9.10.11.12
落地鸡 TLS 端口: 8443
本地监听端口: 10002  ← 自动递增
```

### 访问方式

```bash
# 访问美国网站
curl http://5.6.7.8:10001

# 访问欧洲 API
curl http://5.6.7.8:10002
```

---

## 端口对照表

### 落地鸡端口

| 服务器 | TLS 端口 | 本地服务端口 | 说明 |
|:---|:---:|:---:|:---|
| 美国 1.2.3.4 | 8443 | 80 | 网站服务 |
| 欧洲 9.10.11.12 | 8443 | 3000 | API 服务 |

### 线路鸡端口

| 对外端口 | 连接目标 | 说明 |
|:---:|:---|:---|
| 10001 | 美国:8443 | 访问美国网站 |
| 10002 | 欧洲:8443 | 访问欧洲 API |

---

## 流量路径图

```
用户请求 → 线路鸡:10001 → [TLS加密隧道] → 落地鸡:8443 → 落地鸡:80 → 网站
         香港 5.6.7.8                      美国 1.2.3.4
```

---

## 常见配置场景

### 场景 1：单落地鸡单服务

```
落地鸡: 1.2.3.4
  TLS 端口: 8443
  转发: 127.0.0.1:80

线路鸡: 5.6.7.8
  监听: 10001 → 1.2.3.4:8443

访问: http://5.6.7.8:10001
```

### 场景 2：单落地鸡多服务

```
落地鸡: 1.2.3.4
  TLS 端口 1: 8443 → 127.0.0.1:80 (网站)
  TLS 端口 2: 8444 → 127.0.0.1:3000 (API)

线路鸡: 5.6.7.8
  监听: 10001 → 1.2.3.4:8443
  监听: 10002 → 1.2.3.4:8444

访问网站: http://5.6.7.8:10001
访问API: http://5.6.7.8:10002
```

### 场景 3：多落地鸡单线路鸡

```
落地鸡 A: 1.2.3.4 (TLS: 8443)
落地鸡 B: 9.10.11.12 (TLS: 8443)
落地鸡 C: 13.14.15.16 (TLS: 8443)

线路鸡: 5.6.7.8
  监听: 10001 → 1.2.3.4:8443
  监听: 10002 → 9.10.11.12:8443
  监听: 10003 → 13.14.15.16:8443
```

---

## 配置检查清单

### 落地鸡配置检查

- [ ] TLS 端口已开放（防火墙）
- [ ] gost 服务已启动
- [ ] 本地服务正常运行
- [ ] 可以从线路鸡连接到 TLS 端口

```bash
# 检查服务状态
systemctl status gost

# 检查端口监听
ss -tlnp | grep 8443
```

### 线路鸡配置检查

- [ ] 对外端口已开放（防火墙）
- [ ] gost 服务已启动
- [ ] 可以连接到落地鸡 TLS 端口
- [ ] 本地可以访问服务

```bash
# 检查服务状态
systemctl status gost

# 检查端口监听
ss -tlnp | grep 10001

# 测试连接
curl http://localhost:10001
```

---

## 故障排查

### 问题：无法访问线路鸡端口

**检查步骤：**
1. 线路鸡 gost 服务是否运行？
   ```bash
   systemctl status gost
   ```

2. 端口是否监听？
   ```bash
   ss -tlnp | grep 10001
   ```

3. 防火墙是否开放？
   ```bash
   ufw status | grep 10001
   ```

### 问题：线路鸡无法连接落地鸡

**检查步骤：**
1. 落地鸡 gost 服务是否运行？
2. 落地鸡 TLS 端口是否开放？
3. 网络连通性测试：
   ```bash
   telnet 1.2.3.4 8443
   ```

### 问题：添加新规则后原有规则失效

**原因**：配置未使用追加模式（不应该发生）

**解决**：
1. 查看配置文件：
   ```bash
   sudo cat /etc/gost/config.json
   ```

2. 确认所有规则都在 `forwards` 数组中

3. 重新应用配置：
   ```
   fish → 8 → 2 → 3 (应用配置并启动服务)
   ```

---

## 配置文件位置

- **本地配置**：`/etc/gost/config.json`
- **systemd 服务**：`/etc/systemd/system/gost.service`
- **日志查看**：`journalctl -u gost -f`

---

**提示**：建议先在测试环境验证配置，确认无误后再应用到生产环境。
